parameters:
  moduleName: StreamAnalytics
  moduleVersion: 2.0
  moduleTier: Modules
  moduleSolutionName: StreamAnalytics_2.0
  artifactName: $(artifactName)
  dependsOn: ''
  condition: ''
  connectionService: $(connectionService)
  resourceGroup: $(resourceGroup_asa)
  environment: $(environment)

jobs:
  - deployment:
    displayName: 'Deploy Module ${{ parameters.moduleName }}'
    pool:
      name: $(poolName)
    dependsOn: '${{ parameters.dependsOn }}'
    condition: '${{ parameters.condition }}'
    environment: '${{ parameters.environment }}'
    workspace:
      clean: all
    strategy:
      runOnce:
        deploy:
          steps:
          - download: none
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '${{ parameters.artifactName }}'
              downloadPath: $(System.ArtifactsDirectory)

          - task: AzureKeyVault@1
            inputs:
              azureSubscription: '${{ parameters.connectionService }}'
              KeyVaultName: $(AKV)
              SecretsFilter: 'KeyVault--Name'

          - task: AzureresourceGroupDeployment@2
            displayName: 'Deploy ${{ parameters.moduleName }}'
            inputs:
              azureSubscription: '${{ parameters.connectionService }}'
              resourceGroupName: '${{ parameters.resourceGroup }}'
              location: $(Location)
              csmFile: '$(System.ArtifactsDirectory)/${{ parameters.artifactName }}/${{ parameters.moduleSolutionName }}/${{ parameters.moduleName }}.deploy.json'
              csmParametersFile: '$(System.ArtifactsDirectory)/${{ parameters.artifactName }}/${{ parameters.moduleSolutionName }}/${{ parameters.moduleName }}.parameters.${{ parameters.environment }}.json'
              deploymentMode: Incremental
              deploymentOutputs: resourceGroupDeploymentOutputs

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                $outputs = ConvertFrom-Json $($env:resourceGroupDeploymentOutputs)
                foreach ($output in $outputs.PSObject.Properties) {
                  Write-Host "##vso[task.setvariable variable=$($output.Name)]$($output.Value.value)"
                }

          - task: AzurePowerShell@4
            displayName: 'Test - ${{ parameters.moduleName }} Parameters'
            inputs:
              azureSubscription: '${{ parameters.connectionService }}'
              scriptpath: '$(System.ArtifactsDirectory)/${{ parameters.artifactName }}/${{ parameters.moduleSolutionName }}/Tests/${{ parameters.moduleName }}.output.tests.ps1'
              scriptarguments: '-streamAnalyticsName "$(streamAnalyticsName)" -streamAnalyticsResourceId "$(streamAnalyticsResourceId)"	-streamAnalyticsresourceGroup "$(streamAnalyticsresourceGroup)"'
              azurePowerShellVersion: LatestVersion
     
          - task: AzurePowerShell@4
            displayName: 'Configuration - Add ${{ parameters.moduleName }} Secrets to KeyVault'
            inputs:
              azureSubscription: '${{ parameters.connectionService }}'
              scriptpath: '$(System.ArtifactsDirectory)/${{ parameters.artifactName }}/${{ parameters.moduleSolutionName }}/Scripts/${{ parameters.moduleName }}.akv.set.secrets.ps1'
              scriptarguments: '-keyVaultName "$(KeyVault--Name)" -streamAnalyticsName "$(streamAnalyticsName)" -streamAnalyticsResourceId "$(streamAnalyticsResourceId)"	-streamAnalyticsresourceGroup "$(streamAnalyticsresourceGroup)"'
              azurePowerShellVersion: LatestVersion